<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fire & Smoke Detection</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:      #080b10;
  --surface: #0e1319;
  --border:  #1a2130;
  --muted:   #2a3545;
  --text:    #b8cce0;
  --dim:     #445566;
  --white:   #e8f0f8;
  --fire:    #ff3d1a;
  --smoke:   #8aaccc;
  --safe:    #00e87a;
  --warn:    #ffaa00;
  --head:    'Rajdhani', sans-serif;
  --mono:    'JetBrains Mono', monospace;
}

html,body{height:100vh;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px}

/* â”€â”€ scanlines â”€â”€ */
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:9999}

/* â”€â”€ HEADER â”€â”€ */
header{
  height:52px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.logo{display:flex;align-items:center;gap:10px}
.logo svg{width:28px;height:28px}
.logo-title{font-family:var(--head);font-size:18px;font-weight:700;letter-spacing:3px;color:var(--white)}
.logo-title em{color:var(--fire);font-style:normal}
.hdr-right{display:flex;align-items:center;gap:16px;font-size:11px;color:var(--dim);letter-spacing:1px}
.hdr-src{color:var(--text)}
.pill{
  display:flex;align-items:center;gap:6px;
  font-family:var(--head);font-weight:600;font-size:11px;letter-spacing:2px;
  padding:4px 12px;border:1px solid;border-radius:2px;
}
.pill.running{color:var(--safe);border-color:var(--safe)}
.pill.starting{color:var(--warn);border-color:var(--warn)}
.pill.stopped,.pill.error{color:var(--dim);border-color:var(--muted)}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:blink 1.2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ ALERT BANNER â”€â”€ */
#banner{
  overflow:hidden;max-height:0;
  transition:max-height .35s ease,padding .35s ease;
  flex-shrink:0;
}
#banner.show{max-height:56px;padding:10px 20px}
#banner.fire-bg{background:linear-gradient(90deg,rgba(255,61,26,.25),rgba(255,61,26,.08))}
#banner.smoke-bg{background:linear-gradient(90deg,rgba(138,172,204,.2),rgba(138,172,204,.05))}
.banner-inner{display:flex;align-items:center;gap:14px}
.banner-icon{font-size:24px;animation:rock .4s ease-in-out infinite alternate}
@keyframes rock{from{transform:rotate(-8deg)}to{transform:rotate(8deg)}}
.banner-title{font-family:var(--head);font-weight:700;font-size:17px;letter-spacing:2px;color:#fff}
.banner-sub{font-size:11px;color:rgba(255,255,255,.65);margin-top:2px}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{
  display:grid;
  grid-template-columns:300px 1fr;
  grid-template-rows:1fr auto;
  height:calc(100vh - 52px);
  gap:1px;background:var(--border);
}
.side{
  grid-row:1/3;
  background:var(--surface);
  padding:16px;
  display:flex;flex-direction:column;gap:14px;
  overflow-y:auto;overflow-x:hidden;
}
.side::-webkit-scrollbar{width:3px}
.side::-webkit-scrollbar-thumb{background:var(--muted)}

/* â”€â”€ SECTION LABEL â”€â”€ */
.lbl{
  font-family:var(--head);font-weight:600;font-size:10px;
  letter-spacing:3px;text-transform:uppercase;color:var(--dim);
  padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:8px;
}

/* â”€â”€ BIG STATUS CARD â”€â”€ */
.status-card{
  background:var(--bg);border:1px solid var(--border);border-radius:3px;
  padding:16px;text-align:center;transition:border-color .3s,box-shadow .3s;
}
.status-card.fire-mode{border-color:var(--fire);box-shadow:0 0 24px rgba(255,61,26,.2);animation:pulse-card 1s ease-in-out infinite}
.status-card.smoke-mode{border-color:var(--smoke);box-shadow:0 0 20px rgba(138,172,204,.15)}
.status-card.both-mode{border-color:var(--fire);box-shadow:0 0 24px rgba(255,61,26,.2);animation:pulse-card 1s ease-in-out infinite}
@keyframes pulse-card{0%,100%{box-shadow:0 0 24px rgba(255,61,26,.2)}50%{box-shadow:0 0 48px rgba(255,61,26,.4)}}

.status-main{font-family:var(--head);font-weight:700;font-size:34px;letter-spacing:4px;transition:color .3s}
.status-main.c-fire{color:var(--fire)}
.status-main.c-smoke{color:var(--smoke)}
.status-main.c-safe{color:var(--safe)}
.status-type{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--dim);margin-top:4px}
.status-desc{font-size:11px;color:var(--text);margin-top:10px;line-height:1.6;min-height:32px}

/* â”€â”€ CONFIDENCE â”€â”€ */
.conf-row{display:flex;justify-content:space-between;margin-bottom:5px;font-size:10px}
.conf-track{height:4px;background:var(--muted);border-radius:2px;overflow:hidden}
.conf-fill{height:100%;border-radius:2px;transition:width .5s,background .3s}

/* â”€â”€ STATS GRID â”€â”€ */
.stats{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat{background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:10px}
.stat-val{font-family:var(--head);font-weight:700;font-size:22px;color:var(--white)}
.stat-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-top:2px}

/* â”€â”€ ALERT LOG â”€â”€ */
.log-list{max-height:180px;overflow-y:auto}
.log-list::-webkit-scrollbar{width:2px}
.log-list::-webkit-scrollbar-thumb{background:var(--muted)}
.log-entry{display:flex;align-items:flex-start;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:none}}
.log-time{color:var(--dim);white-space:nowrap;flex-shrink:0}
.log-badge{font-family:var(--head);font-weight:600;font-size:9px;letter-spacing:1px;padding:1px 6px;border-radius:2px;white-space:nowrap;flex-shrink:0;margin-top:1px}
.log-badge.fire{background:rgba(255,61,26,.18);color:var(--fire)}
.log-badge.smoke{background:rgba(138,172,204,.15);color:var(--smoke)}
.log-badge.both{background:rgba(255,170,0,.15);color:var(--warn)}
.log-msg{color:var(--text);line-height:1.5}
.log-empty{color:var(--dim);font-size:11px;padding:8px 0}

.log-path{font-size:9px;color:var(--dim);letter-spacing:1px;border-top:1px solid var(--border);padding-top:10px;word-break:break-all}

/* â”€â”€ VIDEO PANEL â”€â”€ */
.video-wrap{
  position:relative;background:#000;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;height:100%;
}
.video-wrap::after{
  content:'';position:absolute;inset:0;
  border:0px solid transparent;pointer-events:none;z-index:5;
  transition:border-color .25s,box-shadow .25s;
}
.video-wrap.fire-border::after{
  border-width:6px;border-color:var(--fire);
  box-shadow:inset 0 0 40px rgba(255,61,26,.35),0 0 40px rgba(255,61,26,.4);
  animation:border-flash .7s ease-in-out infinite;
}
.video-wrap.smoke-border::after{border-width:4px;border-color:var(--smoke);box-shadow:inset 0 0 30px rgba(138,172,204,.2)}
@keyframes border-flash{0%,100%{box-shadow:inset 0 0 40px rgba(255,61,26,.3),0 0 40px rgba(255,61,26,.35)}50%{box-shadow:inset 0 0 80px rgba(255,61,26,.55),0 0 80px rgba(255,61,26,.55)}}

#stream-img{width:100%;height:100%;object-fit:contain;position:absolute;inset:0;z-index:1}

/* Red vignette overlay */
#vignette{
  position:absolute;inset:0;pointer-events:none;z-index:3;opacity:0;
  transition:opacity .3s;
}
#vignette.show{opacity:1;animation:vig-flash 1s ease-in-out infinite}
@keyframes vig-flash{0%,100%{opacity:.55}50%{opacity:.15}}

/* Centre alert text */
#vid-label{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  font-family:var(--head);font-weight:700;
  font-size:clamp(24px,4vw,52px);letter-spacing:5px;
  color:#fff;text-transform:uppercase;white-space:nowrap;
  pointer-events:none;z-index:4;
  opacity:0;transition:opacity .3s;
}
#vid-label.show{opacity:1;animation:label-pulse 1s ease-in-out infinite}
@keyframes label-pulse{0%,100%{text-shadow:0 0 20px var(--fire),0 0 60px var(--fire)}50%{text-shadow:0 0 40px var(--fire),0 0 120px var(--fire)}}
#vid-label.smoke-label{animation:smoke-pulse 1s ease-in-out infinite}
@keyframes smoke-pulse{0%,100%{text-shadow:0 0 20px var(--smoke),0 0 60px var(--smoke)}50%{text-shadow:0 0 40px var(--smoke),0 0 100px var(--smoke)}}

/* HUD corners */
.hud-tl{position:absolute;top:12px;left:12px;z-index:4;pointer-events:none}
.hud-br{position:absolute;bottom:48px;right:12px;z-index:4;pointer-events:none;text-align:right}
.hud-line{font-size:10px;letter-spacing:2px;color:rgba(184,204,224,.5);text-shadow:0 0 8px rgba(0,0,0,.9)}
.hud-line span{color:rgba(232,240,248,.7)}

/* Connecting overlay */
#connecting{
  position:absolute;inset:0;z-index:6;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(8,11,16,.9);
  font-family:var(--head);letter-spacing:2px;text-align:center;
  transition:opacity .4s;
}
#connecting.hidden{opacity:0;pointer-events:none}
#conn-icon{font-size:44px;margin-bottom:16px;opacity:.35}
#conn-title{font-size:16px;font-weight:600;color:var(--text)}
#conn-sub{font-size:11px;color:var(--dim);margin-top:6px}
#conn-retry{font-size:10px;color:var(--muted);margin-top:6px}

/* â”€â”€ METRICS BAR â”€â”€ */
.metrics{
  background:var(--surface);
  display:grid;grid-template-columns:repeat(4,1fr);
  border-top:1px solid var(--border);
}
.metric{padding:12px 16px;border-right:1px solid var(--border)}
.metric:last-child{border-right:none}
.metric-val{font-family:var(--head);font-weight:700;font-size:26px;color:var(--white)}
.metric-unit{font-size:12px;color:var(--dim);margin-left:3px}
.metric-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-top:3px}
.lat-track{height:3px;background:var(--muted);border-radius:2px;margin-top:6px;overflow:hidden}
.lat-fill{height:100%;border-radius:2px;background:var(--safe);transition:width .5s,background .3s}

/* â”€â”€ POPUP â”€â”€ */
#popup{
  position:fixed;top:64px;right:16px;width:290px;
  background:var(--surface);border:1px solid var(--fire);border-left:4px solid var(--fire);
  border-radius:3px;padding:14px 16px;z-index:9990;
  box-shadow:0 8px 32px rgba(0,0,0,.6);
  transform:translateX(320px);transition:transform .35s cubic-bezier(.175,.885,.32,1.1);
}
#popup.show{transform:translateX(0)}
#popup.smoke-pop{border-color:var(--smoke);border-left-color:var(--smoke)}
.pop-title{font-family:var(--head);font-weight:700;font-size:15px;letter-spacing:2px;color:var(--fire)}
#popup.smoke-pop .pop-title{color:var(--smoke)}
.pop-body{font-size:11px;color:var(--text);margin-top:5px;line-height:1.6}
.pop-time{font-size:10px;color:var(--dim);margin-top:7px}
.pop-close{position:absolute;top:8px;right:10px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:15px;line-height:1;transition:color .2s}
.pop-close:hover{color:var(--white)}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none">
      <path d="M14 2C14 2 20 8 20 14.5C20 18 17.3 21 14 21C10.7 21 8 18 8 14.5C8 11 11 8 11 8C11 8 7 12 7 17C7 22.5 10.1 27 14 27C17.9 27 21 22.5 21 17C21 10 14 2 14 2Z" fill="#ff3d1a" opacity=".9"/>
      <path d="M14 12C14 12 17 15.5 17 18C17 19.7 15.7 21 14 21C12.3 21 11 19.7 11 18C11 16 13 13.5 13 13.5" fill="#ffaa00"/>
      <ellipse cx="14" cy="19.5" rx="1.5" ry="1.5" fill="#fff" opacity=".8"/>
    </svg>
    <div class="logo-title">FIRE &amp; <em>SMOKE</em> DETECTION</div>
  </div>
  <div class="hdr-right">
    <span>SOURCE: <span id="hdr-src" class="hdr-src">â€”</span></span>
    <div class="pill starting" id="pill"><div class="dot"></div><span id="pill-txt">STARTING</span></div>
  </div>
</header>

<!-- ALERT BANNER -->
<div id="banner">
  <div class="banner-inner">
    <div class="banner-icon" id="banner-icon">ðŸ”¥</div>
    <div>
      <div class="banner-title" id="banner-title">FIRE DETECTED</div>
      <div class="banner-sub" id="banner-sub">â€”</div>
    </div>
  </div>
</div>

<!-- LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="side">

    <!-- Detection status -->
    <div>
      <div class="lbl">Detection Status</div>
      <div class="status-card" id="status-card">
        <div class="status-main c-safe" id="status-main">CLEAR</div>
        <div class="status-type" id="status-type">â€” NO HAZARD â€”</div>
        <div class="status-desc" id="status-desc">System initialising...</div>
      </div>
    </div>

    <!-- Confidence -->
    <div>
      <div class="lbl">Confidence</div>
      <div class="conf-row">
        <span style="color:var(--dim);letter-spacing:1px">LEVEL</span>
        <span id="conf-txt" style="color:var(--white)">â€”</span>
      </div>
      <div class="conf-track"><div class="conf-fill" id="conf-fill" style="width:0%"></div></div>
    </div>

    <!-- Stats -->
    <div>
      <div class="lbl">Session Statistics</div>
      <div class="stats">
        <div class="stat"><div class="stat-val" id="s-frames">0</div><div class="stat-lbl">Frames</div></div>
        <div class="stat"><div class="stat-val" id="s-alerts" style="color:var(--fire)">0</div><div class="stat-lbl">Alerts</div></div>
        <div class="stat"><div class="stat-val" id="s-lat">â€”</div><div class="stat-lbl">Last ms</div></div>
        <div class="stat"><div class="stat-val" id="s-last" style="font-size:15px">â€”</div><div class="stat-lbl">Last Alert</div></div>
      </div>
    </div>

    <!-- Alert log -->
    <div style="flex:1;display:flex;flex-direction:column;min-height:0">
      <div class="lbl">Alert History</div>
      <div class="log-list" id="log-list">
        <div class="log-empty">No alerts recorded.</div>
      </div>
    </div>

    <!-- Log path -->
    <div class="log-path">LOG: <span id="log-path">â€”</span></div>

  </aside>

  <!-- VIDEO -->
  <div class="video-wrap" id="video-wrap">
    <!-- vignette overlay -->
    <svg id="vignette" viewBox="0 0 100 100" preserveAspectRatio="none">
      <defs>
        <radialGradient id="vg" cx="50%" cy="50%">
          <stop offset="30%" stop-color="rgba(255,61,26,0)"/>
          <stop offset="100%" stop-color="rgba(255,61,26,0.65)"/>
        </radialGradient>
      </defs>
      <rect width="100" height="100" fill="url(#vg)"/>
    </svg>

    <!-- Stream image -->
    <img id="stream-img" alt="Live feed"/>

    <!-- Alert label -->
    <div id="vid-label"></div>

    <!-- HUD top-left -->
    <div class="hud-tl">
      <div class="hud-line">MODEL: <span id="hud-model">gemma3:4b</span></div>
      <div class="hud-line">BACKEND: <span>Ollama</span></div>
      <div class="hud-line" id="hud-time">TIME: <span>â€”</span></div>
    </div>
    <div class="hud-br">
      <div class="hud-line">JETSON ORIN NX</div>
    </div>

    <!-- Connecting overlay -->
    <div id="connecting">
      <div id="conn-icon">ðŸ“¡</div>
      <div id="conn-title">CONNECTING TO STREAM</div>
      <div id="conn-sub">http://localhost:8080/stream</div>
      <div id="conn-retry"></div>
    </div>
  </div>

  <!-- METRICS BAR -->
  <div class="metrics">
    <div class="metric">
      <div><span class="metric-val" id="m-lat">â€”</span><span class="metric-unit">ms</span></div>
      <div class="metric-lbl">Inference Latency</div>
      <div class="lat-track"><div class="lat-fill" id="lat-bar" style="width:0%"></div></div>
    </div>
    <div class="metric">
      <div class="metric-val" id="m-frames">0</div>
      <div class="metric-lbl">Total Frames</div>
    </div>
    <div class="metric">
      <div class="metric-val" id="m-alerts" style="color:var(--fire)">0</div>
      <div class="metric-lbl">Total Alerts</div>
    </div>
    <div class="metric">
      <div class="metric-val" id="m-src" style="font-size:16px">â€”</div>
      <div class="metric-lbl">Input Source</div>
    </div>
  </div>

</div>

<!-- POPUP -->
<div id="popup">
  <button class="pop-close" onclick="closePopup()">âœ•</button>
  <div class="pop-title" id="pop-title">ðŸ”¥ FIRE DETECTED</div>
  <div class="pop-body" id="pop-body">â€”</div>
  <div class="pop-time" id="pop-time">â€”</div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _prevAlert = false;
let _popTimer  = null;
let _retries   = 0;
let _retryTimer = null;
let _streamConnected = false;

// â”€â”€â”€ Stream connection with auto-retry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectStream() {
  const img        = document.getElementById('stream-img');
  const connecting = document.getElementById('connecting');
  const retryEl    = document.getElementById('conn-retry');

  img.onload = () => {
    _streamConnected = true;
    _retries = 0;
    connecting.classList.add('hidden');
  };

  img.onerror = () => {
    _streamConnected = false;
    connecting.classList.remove('hidden');
    document.getElementById('conn-title').textContent = 'STREAM DISCONNECTED';
    scheduleRetry();
  };

  img.src = '/stream?' + Date.now();
}

function scheduleRetry() {
  _retries++;
  const delay = Math.min(1500 * _retries, 8000);
  document.getElementById('conn-retry').textContent =
    'Retry ' + _retries + ' in ' + (delay / 1000).toFixed(1) + 's...';
  clearTimeout(_retryTimer);
  _retryTimer = setTimeout(connectStream, delay);
}

// Watchdog: if stream stalls, reconnect
setInterval(() => {
  const img = document.getElementById('stream-img');
  if (!_streamConnected || !img.complete || img.naturalWidth === 0) {
    connectStream();
  }
}, 12000);

connectStream();

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function now() {
  return new Date().toLocaleTimeString('en-GB', { hour12: false });
}

function confPct(level) {
  return level === 'high' ? '88%' : level === 'medium' ? '52%' : '22%';
}

function confColour(level, alert) {
  if (!alert) return 'var(--safe)';
  return level === 'high'   ? 'var(--fire)' :
         level === 'medium' ? 'var(--warn)' : 'var(--smoke)';
}

// â”€â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPopup(type, desc, ts) {
  const el = document.getElementById('popup');
  el.className = (type === 'smoke') ? 'show smoke-pop' : 'show';
  document.getElementById('pop-title').textContent =
    type === 'fire'  ? 'ðŸ”¥ FIRE DETECTED'  :
    type === 'smoke' ? 'ðŸ’¨ SMOKE DETECTED' : 'ðŸ”¥ðŸ’¨ FIRE & SMOKE';
  document.getElementById('pop-body').textContent = desc;
  document.getElementById('pop-time').textContent = 'Detected at ' + ts;
  clearTimeout(_popTimer);
  _popTimer = setTimeout(closePopup, 8000);
}

function closePopup() {
  document.getElementById('popup').className = '';
}

// â”€â”€â”€ Alert log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _logEmpty = true;
function addLog(type, desc, ts) {
  const list = document.getElementById('log-list');
  if (_logEmpty) { list.innerHTML = ''; _logEmpty = false; }

  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML =
    `<span class="log-time">${ts}</span>` +
    `<span class="log-badge ${type}">${type.toUpperCase()}</span>` +
    `<span class="log-msg">${desc}</span>`;

  list.prepend(entry);

  // Keep at most 60 entries
  while (list.children.length > 60) list.removeChild(list.lastChild);
}

// â”€â”€â”€ Main update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update(s) {
  // Clock
  document.getElementById('hud-time').innerHTML = 'TIME: <span>' + now() + '</span>';

  // Source & log path
  document.getElementById('hdr-src').textContent  = s.source;
  document.getElementById('m-src').textContent    = s.source;
  document.getElementById('log-path').textContent = s.log_path;

  // Status pill
  const pill = document.getElementById('pill');
  pill.className = 'pill ' + s.status;
  document.getElementById('pill-txt').textContent = s.status.toUpperCase();

  // Counters
  document.getElementById('s-frames').textContent  = s.frame_count.toLocaleString();
  document.getElementById('s-alerts').textContent  = s.alert_count;
  document.getElementById('s-last').textContent    = s.last_alert || 'â€”';
  document.getElementById('m-frames').textContent  = s.frame_count.toLocaleString();
  document.getElementById('m-alerts').textContent  = s.alert_count;

  // Latency
  if (s.latency_ms) {
    const ms  = s.latency_ms;
    const pct = Math.min(ms / 12000 * 100, 100);
    const col = ms < 4000 ? 'var(--safe)' : ms < 8000 ? 'var(--warn)' : 'var(--fire)';
    document.getElementById('s-lat').textContent    = ms + 'ms';
    document.getElementById('m-lat').textContent    = ms;
    document.getElementById('lat-bar').style.width  = pct + '%';
    document.getElementById('lat-bar').style.background = col;
  }

  // Confidence
  document.getElementById('conf-txt').textContent          = s.confidence ? s.confidence.toUpperCase() : 'â€”';
  document.getElementById('conf-fill').style.width         = confPct(s.confidence);
  document.getElementById('conf-fill').style.background    = confColour(s.confidence, s.alert);

  // Description
  document.getElementById('status-desc').textContent = s.description;

  const card    = document.getElementById('status-card');
  const smain   = document.getElementById('status-main');
  const stype   = document.getElementById('status-type');
  const banner  = document.getElementById('banner');
  const vwrap   = document.getElementById('video-wrap');
  const vignette= document.getElementById('vignette');
  const vidLbl  = document.getElementById('vid-label');
  const t = s.type;

  if (s.alert) {
    const isSmoke = (t === 'smoke');
    const isBoth  = (t === 'both');

    // Status card
    card.className  = 'status-card ' + t + '-mode';
    smain.className = 'status-main ' + (isSmoke ? 'c-smoke' : 'c-fire');
    smain.textContent = t === 'both' ? 'DANGER' : t.toUpperCase();
    stype.textContent = 'â€” ' + (isBoth ? 'FIRE & SMOKE' : t.toUpperCase()) + ' â€”';

    // Banner
    banner.className = 'show ' + (isSmoke ? 'smoke-bg' : 'fire-bg');
    document.getElementById('banner-icon').textContent  = isSmoke ? 'ðŸ’¨' : isBoth ? 'ðŸ”¥ðŸ’¨' : 'ðŸ”¥';
    document.getElementById('banner-title').textContent = isSmoke ? 'SMOKE DETECTED' : isBoth ? 'FIRE & SMOKE DETECTED' : 'FIRE DETECTED';
    document.getElementById('banner-sub').textContent   = s.description;

    // Video
    vwrap.className   = 'video-wrap ' + (isSmoke ? 'smoke-border' : 'fire-border');
    vignette.className = isSmoke ? '' : 'show';
    vidLbl.className  = 'show' + (isSmoke ? ' smoke-label' : '');
    vidLbl.textContent = isSmoke ? 'âš  SMOKE' : isBoth ? 'âš  FIRE & SMOKE' : 'âš  FIRE';

    // Trigger popup & log only on new alert
    if (!_prevAlert) {
      const ts = s.last_alert || now();
      showPopup(t, s.description, ts);
      addLog(t, s.description, ts);
    }

  } else {
    card.className  = 'status-card';
    smain.className = 'status-main c-safe';
    smain.textContent  = 'CLEAR';
    stype.textContent  = 'â€” NO HAZARD â€”';
    banner.className   = '';
    vwrap.className    = 'video-wrap';
    vignette.className = '';
    vidLbl.className   = '';
    vidLbl.textContent = '';
  }

  _prevAlert = s.alert;
}

// â”€â”€â”€ Poll /api/state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function poll() {
  try {
    const r = await fetch('/api/state');
    if (r.ok) update(await r.json());
  } catch (_) {}
  setTimeout(poll, 1200);
}

poll();
</script>
</body>
</html>
